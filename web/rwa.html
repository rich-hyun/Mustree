<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>RWA ìƒì„± ë° ê´€ë¦¬</title>
  <meta name="description" content="ì‹¤ë¬¼ìì‚° í† í°í™”(RWA) ìƒì„±, íŒŒì¼ ì—…ë¡œë“œ, ì ‘ê·¼ ê´€ë¦¬ ë° ì¡°íšŒ" />
  <link rel="stylesheet" href="./style.css" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body>
  <header class="app-header">
    <div class="container app-header-inner">
      <!-- ìš”ì²­: ì´ ë¸”ë¡ì€ ì ˆëŒ€ ìˆ˜ì •í•˜ì§€ ì•ŠìŒ -->
      <div class="hdr-left">
        <h1>ë¨¸ìŠ¤íŠ¸ë¦¬ ë„¤íŠ¸ì›Œí¬</h1>
        <nav class="menu">
          <a href="./index.html">í™ˆ</a>
          <a href="./network.html">ë„¤íŠ¸ì›Œí¬ ìƒì„± ì„œë¹„ìŠ¤</a>
          <a href="./api.html">API ì œê³µ ì„œë¹„ìŠ¤</a>
          <a href="./api-guide.html">API ì‚¬ìš© ì„¤ëª…</a>
          <a href="./bridge.html">ë¸Œë¦¿ì§€(ì¤€ë¹„ì¤‘)</a>
          <a href="./sbt.html">SBT ìƒì„±(ì¤€ë¹„ì¤‘)</a>
          <a href="./rwa.html" class="active">RWA ìƒì„±(ì¤€ë¹„ì¤‘)</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="hero">
      <div class="hero-bg" aria-hidden="true"></div>
      <div class="container">
        <p class="eyebrow">RWA & File Management</p>
        <h1>ì‹¤ë¬¼ìì‚° í† í°í™” ë° ë°ì´í„° ê´€ë¦¬</h1>
        <p class="sub">íŒŒì¼ ì—…ë¡œë“œ, ì ‘ê·¼ ì œì–´, RWA í† í° ë°œí–‰ ë“± ëª¨ë“  ê¸°ëŠ¥ì„ ì˜¨ì²´ì¸ì—ì„œ ê´€ë¦¬í•˜ì„¸ìš”.</p>
      </div>
    </section>

    <section class="section">
      <div class="container">
        <div class="max-w-4xl mx-auto">
          <div class="flex justify-center gap-4 mb-8">
            <button onclick="showSection('business')" class="btn primary">Business Section</button>
            <button onclick="showSection('measurement')" class="btn">3D Measurement (ê°œë°œì¤‘)</button>
          </div>

          <div id="business-section">
            <div class="card mb-6">
              <h2 class="text-xl font-bold mb-4">1. ì§€ê°‘ ì—°ê²°</h2>
              <p class="mb-2" id="wallet-status">ë©”íƒ€ë§ˆìŠ¤í¬ ì§€ê°‘ì„ ì—°ê²°í•˜ì„¸ìš”:</p>
              <div class="flex gap-3">
                <button onclick="connectWallet()" class="btn">ì§€ê°‘ ì—°ê²°</button>
                <button onclick="changeWallet()" class="btn" style="background-color:#f59e0b;">ì§€ê°‘ ë³€ê²½</button>
              </div>
              <p id="eth-balance" class="text-blue-600 font-semibold mt-2"></p>
            </div>

            <div class="card mb-6">
              <h2 class="text-xl font-bold mb-4">2. íŒŒì¼ ì—…ë¡œë“œ ë° í•´ì‹œ ì €ì¥</h2>
              <input id="file-input" type="file" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100"/>
              <button type="button" onclick="uploadFile(event)" class="btn primary mt-4">ì—…ë¡œë“œ</button>
              <pre id="upload-result" class="mono mt-2"></pre>
            </div>
            
            <div class="card mb-6">
              <h2 class="text-xl font-bold mb-4">3. íŠ¸ëœì­ì…˜ ë° ì ‘ê·¼ ê´€ë¦¬</h2>

              <div class="mb-4 pb-4 border-b">
                <label class="block font-semibold mb-2">1. í•´ì‹œ ë¸”ë¡ì²´ì¸ì— ì €ì¥</label>
                <div class="form" style="grid-template-columns: 1fr 1fr auto; gap: 8px;">
                  <input type="text" id="storeHashInput" placeholder="íŒŒì¼ í•´ì‹œ ì…ë ¥" />
                  <input type="text" id="storeFilenameInput" placeholder="íŒŒì¼ ì´ë¦„ ì…ë ¥ (ì˜ˆ: report.pdf)" />
                  <button onclick="storeHashOnChain()" class="btn primary">ì €ì¥</button>
                </div>
                <pre id="result" class="mono mt-2"></pre>
              </div>

              <div class="mb-4 pb-4 border-b">
                <label class="block font-semibold mb-2">2. íŒŒì¼ ì ‘ê·¼ ìš”ì²­</label>
                <div class="form" style="grid-template-columns: 1fr; gap: 8px;">
                  <input type="text" id="requestOwnerInput" placeholder="íŒŒì¼ ì†Œìœ ì ì£¼ì†Œ" />
                  <input type="text" id="requestFilenameInput" placeholder="íŒŒì¼ ì´ë¦„" />
                  <input type="text" id="nicknameInput" placeholder="ë³¸ì¸ ë‹‰ë„¤ì„" />
                  <button onclick="requestAccessWithNickname()" class="btn primary">ìš”ì²­</button>
                </div>
                <pre id="access-result" class="mono mt-2"></pre>
              </div>
              
              <div class="mb-4 pb-4 border-b">
                <label class="block font-semibold mb-2">3. ì ‘ê·¼ ìš”ì²­ ìŠ¹ì¸</label>
                <div class="form" style="grid-template-columns: 1fr; gap: 8px;">
                  <input type="text" id="approveFilenameInput" placeholder="íŒŒì¼ ì´ë¦„" />
                  <input type="text" id="viewerAddressInput" placeholder="ìš”ì²­ì ì§€ê°‘ ì£¼ì†Œ" />
                  <input type="text" id="approveNicknameInput" placeholder="ìš”ì²­ì ë‹‰ë„¤ì„" />
                  <button onclick="approveAccess()" class="btn primary">ìŠ¹ì¸</button>
                </div>
                <pre id="approve-result" class="mono mt-2"></pre>
              </div>
              
              <div class="mb-4 pb-4 border-b">
                <label class="block font-semibold mb-2">4. í•´ì‹œ ì¡°íšŒ ë° ë‹¤ìš´ë¡œë“œ</label>
                <div class="form" style="grid-template-columns: 1fr auto;">
                  <input type="text" id="getHashFilenameInput" placeholder="íŒŒì¼ ì´ë¦„"/>
                  <button onclick="getHashFromEvent()" class="btn primary">í•´ì‹œ ì¡°íšŒ</button>
                </div>
                 <pre id="get-hash-result" class="mono mt-2"></pre>
                 <div class="form mt-2" style="grid-template-columns: 1fr auto;">
                   <input type="text" id="downloadHashInput" placeholder="íŒŒì¼ í•´ì‹œ ì…ë ¥" />
                   <button onclick="downloadByHash()" class="btn">PDF ë‹¤ìš´ë¡œë“œ</button>
                 </div>
              </div>
            </div>
            
            <div class="card mb-6">
                <h2 class="text-xl font-bold mb-4">4. ë°ì´í„° ì¡°íšŒ</h2>
                <div class="mb-4 pb-4 border-b">
                  <label class="block font-semibold mb-2">íŒŒì¼ ì ‘ê·¼ ìš”ì²­ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ììš©)</label>
                  <div class="form" style="grid-template-columns: 1fr auto;">
                    <input type="text" id="getAccessRequestsInput" placeholder="íŒŒì¼ ì´ë¦„"/>
                    <button onclick="getAccessRequests()" class="btn">ì¡°íšŒ</button>
                  </div>
                  <div id="accessRequestList" class="mt-3 text-sm"></div>
                </div>
                <div class="mb-4 pb-4 border-b">
                  <label class="block font-semibold mb-2">ìŠ¹ì¸ëœ ì‚¬ìš©ì ëª©ë¡ ì¡°íšŒ</label>
                  <div class="form" style="grid-template-columns: 1fr auto;">
                    <input type="text" id="getApprovedInput" placeholder="íŒŒì¼ ì´ë¦„"/>
                    <button onclick="getApprovedViewers()" class="btn">ì¡°íšŒ</button>
                  </div>
                  <div id="approvedViewerList" class="mt-3 text-sm"></div>
                </div>
                <div class="mb-4 pb-4 border-b">
                  <label class="block font-semibold mb-2">ì „ì²´ ì—´ëŒ ë¡œê·¸ ì¡°íšŒ (ì†Œìœ ììš©)</label>
                   <div class="form" style="grid-template-columns: 1fr auto;">
                    <input type="text" id="getAllAccessLogInput" placeholder="íŒŒì¼ ì´ë¦„"/>
                    <button onclick="getAllAccessLog()" class="btn">ì¡°íšŒ</button>
                  </div>
                  <div id="accessLogList" class="mt-3 text-sm"></div>
                </div>
            </div>

            <div class="card mb-6">
              <h2 class="text-xl font-bold mb-4">5. RWA í† í° ìƒì„± ë° ê´€ë¦¬</h2>
              <div id="rwa-token-form">
                <label class="block text-sm font-medium mb-1">Filename</label>
                <input id="rwaFilename" type="text" placeholder="ì˜ˆ: building_A" class="w-full border rounded p-2 mb-4" />

                <label class="block text-sm font-medium mb-1">Owner Count</label>
                <select id="ownerCount" onchange="renderOwnerInputs()" class="w-full border rounded p-2 mb-4">
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
                <div id="ownerInputs" class="space-y-2 mb-4"></div>
                <div id="shareInputs" class="space-y-2 mb-4"></div>

                <label class="block text-sm font-medium mb-1">Access Holder Count</label>
                <select id="accessHolderCount" onchange="renderAccessInputs()" class="w-full border rounded p-2 mb-2">
                  <option value="0">0</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                </select>
                <div id="accessInputs" class="space-y-2 mb-4"></div>
                <button onclick="createRWAToken()" class="btn primary">RWA í† í° ë“±ë¡</button>
              </div>
              
              <div class="mt-6 pt-4 border-t">
                 <label class="block font-semibold mb-2">RWA í† í° ì£¼ì†Œ ì¡°íšŒ</label>
                 <div class="form" style="grid-template-columns: 1fr auto;">
                    <input type="text" id="tokenAddressFilenameInput" placeholder="Filename ì…ë ¥"/>
                    <button onclick="showTokenAddress()" class="btn">ì£¼ì†Œ ì¡°íšŒ</button>
                 </div>
                 <pre id="tokenAddressResult" class="mono mt-2"></pre>
              </div>

              <div class="mt-6 pt-4 border-t">
                <label class="block font-semibold mb-2">ë‚´ RWA í† í° ë³´ìœ  ëª©ë¡</label>
                <button onclick="listOwnedRWATokens()" class="btn primary">ë³´ìœ  í† í° ì¡°íšŒ</button>
                <div id="ownedRWATokenList" class="mt-3 text-sm space-y-3"></div>
              </div>

               <div class="mt-6 pt-4 border-t">
                <h2 class="text-md font-bold mb-2">ğŸ” ì ‘ê·¼ê¶Œ ìˆ˜ë™ í™•ì¸</h2>
                <div class="form" style="grid-template-columns: 1fr 1fr auto;">
                  <input type="text" id="accessCheckFilename" placeholder="íŒŒì¼ ì´ë¦„"/>
                  <input type="text" id="accessCheckUser" placeholder="ì§€ê°‘ ì£¼ì†Œ (ì„ íƒì‚¬í•­)"/>
                  <button onclick="checkAccessManually()" class="btn">í™•ì¸</button>
                </div>
                <div id="manualAccessCheckResult" class="mt-2"></div>
              </div>
            </div>
          </div>

          <div id="measurement-section" style="display: none;">
            <div class="card text-center">
              <h2 class="text-2xl font-bold text-gray-700">ğŸš§ ì‹œìŠ¤í…œ ê°œë°œì¤‘</h2>
              <p class="text-gray-500 mt-2">ì´ ê¸°ëŠ¥ì€ í˜„ì¬ ê°œë°œ ì¤‘ì…ë‹ˆë‹¤.</p>
            </div>
          </div>
        </div>
        </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="foot">
      <div>Â© Mustree Network</div>
      <nav><a href="./resources.html">ë¬¸ì„œ</a><a href="./resources.html#security">ë³´ì•ˆ ì •ì±…</a></nav>
    </div>
  </footer>

  <script>
    // ================================
    // 1. ì´ˆê¸° ì„¤ì • (ìƒìˆ˜ ë° ABI)
    // ================================
    let contract;
    const CONTRACT_ADDRESS = "0x313601af752fb9de89df1a31e12e30c96718a9d7";

    // âœ… [ì‹ ê·œ] JavaScript ì½”ë“œì—ì„œ ì‚¬ìš©í•˜ëŠ” í•¨ìˆ˜ë“¤ë¡œ ìƒˆë¡œ êµ¬ì„±í•œ ABI
    const CONTRACT_ABI = [
        {"name": "storeHash", "type": "function", "inputs": [{"name": "hash", "type": "string"}, {"name": "filename", "type": "string"}], "stateMutability": "nonpayable"},
        {"name": "requestAccessWithNickname", "type": "function", "inputs": [{"name": "owner", "type": "address"}, {"name": "filename", "type": "string"}, {"name": "nickname", "type": "string"}], "stateMutability": "nonpayable"},
        {"name": "hasUserRequested", "type": "function", "inputs": [{"name": "owner", "type": "address"}, {"name": "filename", "type": "string"}, {"name": "requester", "type": "address"}], "stateMutability": "view", "outputs": [{"type": "bool"}]},
        {"name": "approveAccess", "type": "function", "inputs": [{"name": "filename", "type": "string"}, {"name": "requester", "type": "address"}, {"name": "nickname", "type": "string"}], "stateMutability": "nonpayable"},
        {"name": "getHash", "type": "function", "inputs": [{"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "string"}]},
        {"name": "manager", "type": "function", "inputs": [], "stateMutability": "view", "outputs": [{"type": "address"}]},
        {"name": "fileOwner", "type": "function", "inputs": [{"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "address"}]},
        {"name": "getAccessRequests", "type": "function", "inputs": [{"name": "owner", "type": "address"}, {"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "address[]"}]},
        {"name": "getApprovedViewers", "type": "function", "inputs": [{"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "address[]"}]},
        {"name": "getViewers", "type": "function", "inputs": [{"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "tuple[]", "components": [{"name": "viewer", "type": "address"}, {"name": "hash", "type": "string"}, {"name": "timestamp", "type": "uint256"}]}]},
        {"name": "registerRWAWithAccess", "type": "function", "inputs": [{"name": "filename", "type": "string"}, {"name": "owners", "type": "address[]"}, {"name": "shares", "type": "uint256[]"}, {"name": "accessHolders", "type": "address[]"}], "stateMutability": "nonpayable"},
        {"name": "getTokenAddress", "type": "function", "inputs": [{"name": "filename", "type": "string"}], "stateMutability": "view", "outputs": [{"type": "address"}]},
        {"name": "getAllFilenameCount", "type": "function", "inputs": [], "stateMutability": "view", "outputs": [{"type": "uint256"}]},
        {"name": "allFilenames", "type": "function", "inputs": [{"name": "index", "type": "uint256"}], "stateMutability": "view", "outputs": [{"type": "string"}]},
        {"name": "hasAccess", "type": "function", "inputs": [{"name": "filename", "type": "string"}, {"name": "user", "type": "address"}], "stateMutability": "view", "outputs": [{"type": "bool"}]},
    ];

    const ERC20_ABI = [
        {"constant": true, "inputs": [{"name": "owner", "type": "address"}], "name": "balanceOf", "outputs": [{"name": "balance", "type": "uint256"}], "type": "function"},
        {"constant": true, "inputs": [], "name": "decimals", "outputs": [{"name": "", "type": "uint8"}], "type": "function"}
    ];

    // MetaMask ê³„ì • ë³€ê²½ ê°ì§€
    if (typeof window.ethereum !== 'undefined') {
      window.ethereum.on('accountsChanged', async (accounts) => {
        if (accounts.length > 0) {
          const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
          document.getElementById('wallet-status').innerText = `âœ… ê³„ì • ë³€ê²½: ${accounts[0]}`;
          const balance = await provider.getBalance(accounts[0]);
          const formatted = ethers.utils.formatEther(balance);
          document.getElementById('eth-balance').innerText = `ETH ì”ì•¡ (Sepolia): ${formatted} ETH`;
        } else {
          document.getElementById('wallet-status').innerText = `âŒ ì§€ê°‘ ì—°ê²° í•´ì œë¨`;
          document.getElementById('eth-balance').innerText = '';
        }
      });
    }

    window.addEventListener("DOMContentLoaded", () => {
      setTimeout(() => {
        if (typeof window.ethereum !== "undefined") {
          console.log("âœ… MetaMask is available.");
          checkWalletConnection();
        } else {
          console.warn("âŒ MetaMask not found.");
        }
      }, 300);
    });

    // ================================
    // 2. ê¸°ë³¸ ìœ í‹¸ í•¨ìˆ˜
    // ================================
    async function getContractInstance() {
      const provider = new ethers.providers.Web3Provider(window.ethereum);
      const signer = provider.getSigner();
      return new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    }

    function showSection(type) {
      document.getElementById('business-section').style.display = type === 'business' ? 'block' : 'none';
      document.getElementById('measurement-section').style.display = type === 'measurement' ? 'block' : 'none';
    }

    function downloadByHash() {
      const hash = document.getElementById("downloadHashInput").value.trim();
      if (!hash) {
        alert("í•´ì‹œê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      // ì—°êµ¬ì‹¤ ì„œë²„ í™˜ê²½ì„ ìœ„í•´ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
      window.open(`/download?hash=${hash}`, "_blank");
    }

    // ================================
    // 3. ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜
    // ================================
    async function checkWalletConnection() {
      if (typeof window.ethereum === 'undefined') return;
      try {
        const accounts = await window.ethereum.request({ method: "eth_accounts" });
        if (accounts.length > 0) {
            const address = accounts[0];
            const provider = new ethers.providers.Web3Provider(window.ethereum);
            const signer = provider.getSigner();
            contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
            
            document.getElementById('wallet-status').innerText = `âœ… ì—°ê²°ë¨: ${address}`;
            const balance = await provider.getBalance(address);
            const formatted = ethers.utils.formatEther(balance);
            document.getElementById('eth-balance').innerText = `ETH ì”ì•¡ (Sepolia): ${formatted} ETH`;
        }
      } catch (err) {
        console.error("ì§€ê°‘ í™•ì¸ ì‹¤íŒ¨:", err);
      }
    }
    
    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert("MetaMask not detected");
        return;
      }
      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum, "any");
        await provider.send("eth_requestAccounts", []);
        const signer = provider.getSigner();
        const address = await signer.getAddress();
        contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

        document.getElementById('wallet-status').innerText = `âœ… ì—°ê²°ë¨: ${address}`;
        const balance = await provider.getBalance(address);
        const formatted = ethers.utils.formatEther(balance);
        document.getElementById('eth-balance').innerText = `ETH ì”ì•¡ (Sepolia): ${formatted} ETH`;
      } catch (err) {
        console.error(err);
        alert("ì§€ê°‘ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
      }
    }

    async function changeWallet() {
        // connectWalletê³¼ ë™ì¼í•œ ë¡œì§ìœ¼ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
        await connectWallet();
    }

    // ================================
    // 4. íŒŒì¼ ì—…ë¡œë“œ ê´€ë ¨ í•¨ìˆ˜
    // ================================
    async function uploadFile(event) {
      event.preventDefault();
      const fileInput = document.getElementById("file-input");
      const file = fileInput.files[0];
      const resultEl = document.getElementById("upload-result");

      if (!file) {
        alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");
        return;
      }

      const formData = new FormData();
      formData.append("file", file);
      resultEl.innerText = "â³ ì—…ë¡œë“œ ì¤‘ì…ë‹ˆë‹¤...";

      try {
        // ì—°êµ¬ì‹¤ ì„œë²„ í™˜ê²½ì„ ìœ„í•´ ìƒëŒ€ ê²½ë¡œë¡œ ë³€ê²½
        const response = await fetch("/upload", {
          method: "POST",
          body: formData
        });
        const result = await response.json();
        if (response.ok) {
          resultEl.innerHTML = `âœ… ${result.message}<br>ğŸ”‘ í•´ì‹œê°’: ${result.hash}<br>ğŸ”— íŠ¸ëœì­ì…˜ í•´ì‹œ: ${result.tx_hash}<br>ğŸ” <a href="https://sepolia.etherscan.io/tx/${result.tx_hash}" target="_blank" class="text-blue-600 underline">Etherscanì—ì„œ í™•ì¸</a>`;
        } else {
          resultEl.innerText = `âŒ ì—…ë¡œë“œ ì‹¤íŒ¨: ${result.error}`;
        }
      } catch (err) {
        console.error("Upload failed:", err);
        resultEl.innerText = "âŒ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    async function storeHashOnChain() {
      const hash = document.getElementById("storeHashInput").value.trim();
      const filename = document.getElementById("storeFilenameInput").value.trim();
      const resultEl = document.getElementById("result"); 

      if (!hash || !filename) {
        alert("í•´ì‹œê°’ê³¼ íŒŒì¼ ì´ë¦„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        resultEl.innerText = "â³ íŠ¸ëœì­ì…˜ ì „ì†¡ ì¤‘...";
        const tx = await contract.storeHash(hash, filename);
        await tx.wait();
        resultEl.innerHTML = `âœ… íŠ¸ëœì­ì…˜ ì „ì†¡ë¨!<br>ğŸ§¾ Tx Hash: <code>${tx.hash}</code><br>ğŸ” <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener noreferrer">Etherscanì—ì„œ í™•ì¸</a>`;
      } catch (err) {
        console.error(err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message || err}`;
      }
    }

    // ================================
    // 5. ì ‘ê·¼ ìš”ì²­/ìŠ¹ì¸ ê´€ë ¨ í•¨ìˆ˜
    // ================================
    async function requestAccessWithNickname() {
      const owner = document.getElementById("requestOwnerInput").value.trim();
      const filename = document.getElementById("requestFilenameInput").value.trim();
      const nickname = document.getElementById("nicknameInput").value.trim();
      const resultEl = document.getElementById("access-result");
      
      if (!owner || !filename || !nickname) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        resultEl.innerText = "â³ ì ‘ê·¼ ìš”ì²­ ì¤‘ì…ë‹ˆë‹¤...";
        const tx = await contract.requestAccessWithNickname(owner, filename, nickname);
        await tx.wait();
        resultEl.innerHTML = `âœ… ì ‘ê·¼ ìš”ì²­ ì™„ë£Œ!<br>ğŸ”— íŠ¸ëœì­ì…˜ í•´ì‹œ: <code>${tx.hash}</code><br>ğŸ” <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" class="text-blue-600 underline">Etherscanì—ì„œ í™•ì¸</a>`;
      } catch (err) {
        console.error("âŒ ì ‘ê·¼ ìš”ì²­ ì‹¤íŒ¨:", err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message || err}`;
      }
    }

    async function approveAccess() {
      const filename = document.getElementById("approveFilenameInput").value.trim();
      const requester = document.getElementById("viewerAddressInput").value.trim();
      const nickname = document.getElementById("approveNicknameInput").value.trim();
      const resultEl = document.getElementById("approve-result");

      if (!filename || !requester || !nickname) {
        alert("ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        resultEl.innerText = "â³ ì ‘ê·¼ ìŠ¹ì¸ ì¤‘ì…ë‹ˆë‹¤...";
        const tx = await contract.approveAccess(filename, requester, nickname);
        await tx.wait();
        resultEl.innerHTML = `âœ… ì ‘ê·¼ ìŠ¹ì¸ ì™„ë£Œ!<br>ğŸ§¾ Tx Hash: <code>${tx.hash}</code><br>ğŸ” <a href="https://sepolia.etherscan.io/tx/${tx.hash}" target="_blank" rel="noopener noreferrer">Etherscanì—ì„œ í™•ì¸</a>`;
      } catch (err) {
        console.error("âŒ ì ‘ê·¼ ìŠ¹ì¸ ì‹¤íŒ¨:", err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message || err}`;
      }
    }

    async function getHashFromEvent() {
      const filename = document.getElementById("getHashFilenameInput").value.trim();
      const resultEl = document.getElementById("get-hash-result");

      if (!filename) {
        alert("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        resultEl.innerText = "â³ í•´ì‹œ ì¡°íšŒ ì¤‘...";
        // getHashëŠ” view í•¨ìˆ˜ì´ë¯€ë¡œ íŠ¸ëœì­ì…˜ì´ ë°œìƒí•˜ì§€ ì•ŠìŒ
        const hash = await contract.getHash(filename);
        if (hash) {
           resultEl.innerText = `ğŸ“¦ í•´ë‹¹ íŒŒì¼ í•´ì‹œ: ${hash}`;
        } else {
           resultEl.innerText = "âŒ í•´ì‹œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
        }
      } catch (err) {
        console.error("âŒ í•´ì‹œ ì¡°íšŒ ì‹¤íŒ¨:", err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message || err}`;
      }
    }

    // ================================
    // 6. ì¡°íšŒ ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
    // ================================
    async function getAccessRequests() {
      const filename = document.getElementById("getAccessRequestsInput").value.trim();
      if (!filename) {
        alert("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }

      try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        const currentUser = accounts[0];
        const managerAddress = await contract.manager();
        if (currentUser.toLowerCase() !== managerAddress.toLowerCase()) {
          alert("ì´ ê¸°ëŠ¥ì€ ê´€ë¦¬ìë§Œ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
          return;
        }

        const ownerAddress = await contract.fileOwner(filename);
        const requestList = await contract.getAccessRequests(ownerAddress, filename);
        showAccessRequests(requestList);
      } catch (err) {
        console.error("âŒ ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", err);
        alert("ìš”ì²­ ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    function showAccessRequests(addresses) {
      const container = document.getElementById("accessRequestList");
      container.innerHTML = "";
      if (addresses.length === 0) {
        container.textContent = "ìš”ì²­ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      const ul = document.createElement("ul");
      ul.className = "list-disc pl-5";
      addresses.forEach(addr => {
        const li = document.createElement("li");
        li.textContent = addr;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    async function getApprovedViewers() {
      const filename = document.getElementById("getApprovedInput").value.trim();
      if (!filename) {
        alert("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        const viewers = await contract.getApprovedViewers(filename);
        showApprovedViewers(viewers);
      } catch (err) {
        console.error("âŒ ìŠ¹ì¸ì ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", err);
        alert("ìŠ¹ì¸ì ëª©ë¡ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    function showApprovedViewers(viewers) {
      const container = document.getElementById("approvedViewerList");
      container.innerHTML = "";
      if (viewers.length === 0) {
        container.textContent = "ìŠ¹ì¸ëœ ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      const ul = document.createElement("ul");
      ul.className = "list-disc pl-5";
      viewers.forEach(addr => {
        const li = document.createElement("li");
        li.textContent = addr;
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    async function getAllAccessLog() {
      const filename = document.getElementById("getAllAccessLogInput").value.trim();
      if (!filename) {
        alert("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      if (!contract) {
        alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”.");
        return;
      }
      try {
        const accounts = await ethereum.request({ method: "eth_requestAccounts" });
        const currentUser = accounts[0];
        const owner = await contract.fileOwner(filename);

        if (currentUser.toLowerCase() !== owner.toLowerCase()) {
          alert("ì´ íŒŒì¼ì˜ ì†Œìœ ìê°€ ì•„ë‹ˆë¯€ë¡œ ì—´ëŒ ë¡œê·¸ë¥¼ ë³¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }

        const logs = await contract.getViewers(filename);
        showAccessLog(logs);
      } catch (err) {
        console.error("âŒ ì—´ëŒ ë¡œê·¸ ì¡°íšŒ ì‹¤íŒ¨:", err);
        alert("ì—´ëŒ ë¡œê·¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
      }
    }

    function showAccessLog(logs) {
      const container = document.getElementById("accessLogList");
      container.innerHTML = "";
      if (logs.length === 0) {
        container.textContent = "ì—´ëŒ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }
      const ul = document.createElement("ul");
      logs.forEach((log) => {
        const li = document.createElement("li");
        const date = new Date(Number(log.timestamp) * 1000).toLocaleString();
        li.innerHTML = `ğŸ“„ <strong>${log.hash}</strong><br>ğŸ™‹â€â™‚ï¸ ${log.viewer}<br>ğŸ•’ ${date}`;
        li.className = "mb-3 p-2 bg-gray-50 border rounded";
        ul.appendChild(li);
      });
      container.appendChild(ul);
    }

    // ================================
    // 7. RWA í† í° ê´€ë ¨ í•¨ìˆ˜
    // ================================
    function renderOwnerInputs() {
      const count = parseInt(document.getElementById("ownerCount").value);
      const ownerInputs = document.getElementById("ownerInputs");
      const shareInputs = document.getElementById("shareInputs");

      ownerInputs.innerHTML = `<label class="font-medium text-sm">Owner Addresses</label>`;
      shareInputs.innerHTML = `<label class="font-medium text-sm">Shares</label>`;

      for (let i = 0; i < count; i++) {
        ownerInputs.innerHTML += `<input type="text" id="owner_${i}" placeholder="0x..." class="w-full border rounded p-2" />`;
        shareInputs.innerHTML += `<input type="number" id="share_${i}" placeholder="e.g. 20" class="w-full border rounded p-2" />`;
      }
    }

    function renderAccessInputs() {
      const count = parseInt(document.getElementById("accessHolderCount").value);
      const accessInputs = document.getElementById("accessInputs");

      accessInputs.innerHTML = `<label class="font-medium text-sm">Access Holders</label>`;
      for (let i = 0; i < count; i++) {
        accessInputs.innerHTML += `<input type="text" id="access_${i}" placeholder="0x..." class="w-full border rounded p-2 mb-1" />`;
      }
    }
    // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ë³¸ ì…ë ¥ì°½ ìƒì„±
    document.addEventListener('DOMContentLoaded', () => {
        renderOwnerInputs();
        renderAccessInputs();
    });

    async function createRWAToken() {
      const filename = document.getElementById("rwaFilename").value;
      const count = parseInt(document.getElementById("ownerCount").value);
      const accessCount = parseInt(document.getElementById("accessHolderCount").value);
      
      if (!contract) { alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }
      if (!filename) { alert("íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

      const owners = [];
      const shares = [];
      const access = [];

      for (let i = 0; i < count; i++) {
        owners.push(document.getElementById(`owner_${i}`).value);
        shares.push(parseInt(document.getElementById(`share_${i}`).value));
      }
      for (let i = 0; i < accessCount; i++) {
        access.push(document.getElementById(`access_${i}`).value);
      }
      try {
        const tx = await contract.registerRWAWithAccess(filename, owners, shares, access);
        await tx.wait();
        alert(`âœ… RWA í† í° ìƒì„± ì™„ë£Œ!\nğŸ“¦ Tx Hash: ${tx.hash}`);
      } catch (err) {
        console.error("âŒ RWA ìƒì„± ì‹¤íŒ¨:", err);
        alert("RWA í† í° ìƒì„± ì‹¤íŒ¨: " + (err.reason || err.message || err));
      }
    }

    async function showTokenAddress() {
      const filename = document.getElementById("tokenAddressFilenameInput").value.trim();
      const resultEl = document.getElementById("tokenAddressResult");
      if (!filename) {
        resultEl.innerText = "âŒ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }
       if (!contract) { alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }

      try {
        const tokenAddress = await contract.getTokenAddress(filename);
        if (tokenAddress === "0x0000000000000000000000000000000000000000") {
          resultEl.innerText = "âŒ í•´ë‹¹ íŒŒì¼ì— ëŒ€í•œ í† í° ì£¼ì†Œê°€ ì—†ìŠµë‹ˆë‹¤.";
        } else {
          resultEl.innerText = `âœ… RWA Token Address:\n${tokenAddress}`;
        }
      } catch (err) {
        console.error("âŒ getTokenAddress ì‹¤íŒ¨:", err);
        resultEl.innerText = "âŒ ì˜¤ë¥˜ ë°œìƒ: " + (err.reason || err.message || err);
      }
    }

    async function listOwnedRWATokens() {
      const resultEl = document.getElementById("ownedRWATokenList");
      resultEl.innerHTML = "â³ ì¡°íšŒ ì¤‘ì…ë‹ˆë‹¤...";
      if (!contract) { alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }

      try {
        const provider = new ethers.providers.Web3Provider(window.ethereum);
        const signer = provider.getSigner();
        const user = await signer.getAddress();
        const total = await contract.getAllFilenameCount();
        const ownedList = [];

        for (let i = 0; i < total; i++) {
          const filename = await contract.allFilenames(i);
          const tokenAddress = await contract.getTokenAddress(filename);
          if (tokenAddress === "0x0000000000000000000000000000000000000000") continue;

          const token = new ethers.Contract(tokenAddress, ERC20_ABI, provider);
          const balance = await token.balanceOf(user);
          
          if (balance.gt(0)) {
            const decimals = await token.decimals();
            const readable = ethers.utils.formatUnits(balance, decimals);
            const access = await contract.hasAccess(filename, user);
            ownedList.push({ filename, tokenAddress, balance: readable, access });
          }
        }

        if (ownedList.length === 0) {
          resultEl.innerText = "âŒ ë³´ìœ  ì¤‘ì¸ RWA í† í°ì´ ì—†ìŠµë‹ˆë‹¤.";
        } else {
          resultEl.innerHTML = ownedList.map(item => `
            <div class="p-4 border rounded bg-gray-50 mb-3 shadow-sm">
              <div class="font-semibold text-lg">ğŸ“ ${item.filename}</div>
              <div class="text-sm mt-1">ğŸ’° ë³´ìœ ëŸ‰: ${item.balance}</div>
              <div class="text-sm mt-1">ğŸ”— Token Address: <code>${item.tokenAddress}</code></div>
              ${item.access 
                ? `<div class="mt-2 text-green-700 font-semibold">âœ… ì ‘ê·¼ê¶Œ ë³´ìœ 
                    <button onclick="downloadWithAccess('${item.filename}')" class="ml-3 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">ë‹¤ìš´ë¡œë“œ</button>
                   </div>`
                : `<div class="mt-2 text-gray-500">ğŸ”’ ì ‘ê·¼ê¶Œ ì—†ìŒ</div>`
              }
            </div>
          `).join("");
        }
      } catch (err) {
        console.error("âŒ RWA ë³´ìœ  í† í° ì¡°íšŒ ì‹¤íŒ¨:", err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.message || err}`;
      }
    }
    
    async function downloadWithAccess(filename) {
      if (!contract) { alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }
      try {
        const hash = await contract.getHash(filename);
        window.open(`/download?hash=${hash}`, "_blank");
      } catch (err) {
        console.error("âŒ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:", err);
        alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: " + (err.reason || err.message));
      }
    }

    async function checkAccessManually() {
      const filename = document.getElementById("accessCheckFilename").value.trim();
      const userInput = document.getElementById("accessCheckUser").value.trim();
      const resultEl = document.getElementById("manualAccessCheckResult");

      if (!filename) {
        resultEl.innerText = "âŒ íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
      }
      if (!contract) { alert("ì§€ê°‘ì„ ë¨¼ì € ì—°ê²°í•´ì£¼ì„¸ìš”."); return; }

      try {
        const signer = (new ethers.providers.Web3Provider(window.ethereum)).getSigner();
        const user = userInput || await signer.getAddress();
        
        const access = await contract.hasAccess(filename, user);
        if (access) {
          resultEl.innerHTML = `âœ… ì ‘ê·¼ê¶Œ ìˆìŒ. <button onclick="downloadWithAccess('${filename}')" class="ml-3 px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 text-xs">ë‹¤ìš´ë¡œë“œ</button>`;
        } else {
          resultEl.innerText = "âŒ ì ‘ê·¼ê¶Œ ì—†ìŒ.";
        }
      } catch (err) {
        console.error("ì ‘ê·¼ê¶Œ í™•ì¸ ì‹¤íŒ¨:", err);
        resultEl.innerText = `âŒ ì˜¤ë¥˜ ë°œìƒ: ${err.reason || err.message || err}`;
      }
    }
  </script>
</body>
</html>